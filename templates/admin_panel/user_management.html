{% extends 'admin_panel/base.html' %}

{% block title %}User Management - AURA Admin{% endblock %}

{% block content %}
<div class="page-header">
    <h1>User Management</h1>
    <p>Manage user accounts, permissions, and activity</p>
</div>

<!-- Search and Filters -->
<div class="dashboard-card" style="margin-bottom: 1.5rem;">
    <form method="GET" class="search-form" style="display: flex; gap: 1rem; align-items: end;">
        <div class="form-group" style="flex: 1; margin-bottom: 0;">
            <label class="form-label" for="search">Search Users</label>
            <input type="text" 
                   id="search" 
                   name="search" 
                   class="form-input" 
                   placeholder="Search by username, email, or name..."
                   value="{{ search_query }}">
        </div>
        
        <div class="form-group" style="margin-bottom: 0;">
            <label class="form-label" for="status">Status Filter</label>
            <select id="status" name="status" class="form-input">
                <option value="all" {% if filter_status == 'all' %}selected{% endif %}>All Users</option>
                <option value="active" {% if filter_status == 'active' %}selected{% endif %}>Active Only</option>
                <option value="suspended" {% if filter_status == 'suspended' %}selected{% endif %}>Suspended Only</option>
            </select>
        </div>
        
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-search"></i> Search
        </button>
        
        <a href="{% url 'admin_panel:export_data' %}?type=users" class="btn btn-success">
            <i class="fas fa-download"></i> Export CSV
        </a>
    </form>
</div>

<!-- Users Table -->
<div class="table-container">
    <div class="table-header">
        <h3 class="table-title">Users ({{ users.paginator.count }} total)</h3>
    </div>
    <table class="table">
        <thead>
            <tr>
                <th>User</th>
                <th>Email</th>
                <th>Joined</th>
                <th>Last Login</th>
                <th>Status</th>
                <th>Activity</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <div style="width: 32px; height: 32px; background: #667eea; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                            {{ user.first_name.0|default:user.username.0|upper }}
                        </div>
                        <div>
                            <strong>{{ user.get_full_name|default:user.username }}</strong>
                            {% if user.is_staff %}
                                <span class="badge warning">Staff</span>
                            {% endif %}
                            {% if user.is_superuser %}
                                <span class="badge error">Admin</span>
                            {% endif %}
                        </div>
                    </div>
                </td>
                <td>{{ user.email|default:"No email" }}</td>
                <td>{{ user.date_joined|date:"M d, Y" }}</td>
                <td>
                    {% if user.last_login %}
                        {{ user.last_login|timesince }} ago
                    {% else %}
                        Never
                    {% endif %}
                </td>
                <td>
                    {% if user.is_active %}
                        <span class="badge active">Active</span>
                    {% else %}
                        <span class="badge inactive">Suspended</span>
                    {% endif %}
                </td>
                <td>
                    {% if user.attendeeprofile %}
                        <small>
                            Interests: {{ user.attendeeprofile.interests|truncatechars:30 }}<br>
                            Company: {{ user.attendeeprofile.company|default:"Not specified" }}
                        </small>
                    {% else %}
                        <small>No profile</small>
                    {% endif %}
                </td>
                <td>
                    <div style="display: flex; gap: 0.25rem;">
                        {% if not user.is_superuser %}
                            <button onclick="suspendUser({{ user.id }}, '{{ user.username }}', {{ user.is_active|yesno:'false,true' }})" 
                                    class="btn btn-sm {% if user.is_active %}btn-warning{% else %}btn-success{% endif %}">
                                {% if user.is_active %}
                                    <i class="fas fa-ban"></i>
                                {% else %}
                                    <i class="fas fa-check"></i>
                                {% endif %}
                            </button>
                        {% endif %}
                        <a href="/admin/auth/user/{{ user.id }}/change/" class="btn btn-sm btn-primary">
                            <i class="fas fa-edit"></i>
                        </a>
                    </div>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" style="text-align: center; padding: 2rem; color: #666;">
                    No users found matching your criteria.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if users.has_other_pages %}
<div style="display: flex; justify-content: center; margin-top: 1rem;">
    <nav style="display: flex; gap: 0.5rem;">
        {% if users.has_previous %}
            <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if filter_status != 'all' %}&status={{ filter_status }}{% endif %}" class="btn btn-primary">First</a>
            <a href="?page={{ users.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if filter_status != 'all' %}&status={{ filter_status }}{% endif %}" class="btn btn-primary">Previous</a>
        {% endif %}
        
        <span class="btn" style="background: #f3f4f6;">
            Page {{ users.number }} of {{ users.paginator.num_pages }}
        </span>
        
        {% if users.has_next %}
            <a href="?page={{ users.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if filter_status != 'all' %}&status={{ filter_status }}{% endif %}" class="btn btn-primary">Next</a>
            <a href="?page={{ users.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if filter_status != 'all' %}&status={{ filter_status }}{% endif %}" class="btn btn-primary">Last</a>
        {% endif %}
    </nav>
</div>
{% endif %}

<!-- Suspension Modal -->
<div id="suspensionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; max-width: 500px; width: 90%;">
        <h3 id="modalTitle">Suspend User</h3>
        <form id="suspensionForm">
            {% csrf_token %}
            <div class="form-group">
                <label class="form-label">Reason (optional)</label>
                <textarea id="suspensionReason" class="form-input" rows="3" placeholder="Enter reason for suspension..."></textarea>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                <button type="button" onclick="closeSuspensionModal()" class="btn">Cancel</button>
                <button type="submit" id="suspensionSubmit" class="btn btn-warning">Suspend User</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentUserId = null;
let currentAction = null;

function suspendUser(userId, username, isSuspending) {
    currentUserId = userId;
    currentAction = isSuspending ? 'suspend' : 'unsuspend';
    
    const modal = document.getElementById('suspensionModal');
    const title = document.getElementById('modalTitle');
    const submit = document.getElementById('suspensionSubmit');
    const reasonField = document.getElementById('suspensionReason');
    
    if (isSuspending) {
        title.textContent = `Suspend User: ${username}`;
        submit.textContent = 'Suspend User';
        submit.className = 'btn btn-warning';
        reasonField.style.display = 'block';
        reasonField.previousElementSibling.style.display = 'block';
    } else {
        title.textContent = `Reactivate User: ${username}`;
        submit.textContent = 'Reactivate User';
        submit.className = 'btn btn-success';
        reasonField.style.display = 'none';
        reasonField.previousElementSibling.style.display = 'none';
    }
    
    modal.style.display = 'block';
}

function closeSuspensionModal() {
    document.getElementById('suspensionModal').style.display = 'none';
    document.getElementById('suspensionReason').value = '';
    currentUserId = null;
    currentAction = null;
}

document.getElementById('suspensionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!currentUserId) return;
    
    const reason = document.getElementById('suspensionReason').value;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch(`/admin-panel/users/suspend/${currentUserId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
        },
        body: `reason=${encodeURIComponent(reason)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error occurred');
    });
    
    closeSuspensionModal();
});

// Close modal when clicking outside
document.getElementById('suspensionModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeSuspensionModal();
    }
});
</script>
{% endblock %}